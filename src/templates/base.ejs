<% // File Header %>
// Auto-generated by Invoker Generator
// This file contains the Request, Response, and BaseHandler classes.

<% // Request Class %>
export class Request {
  method: string;
  headers: Record<string, string>;
  body: any;
  url: string;

  private urlInstance: URL;

  constructor(
    method: string,
    headers: Record<string, string> = {},
    body: any = null,
    url: string = ""
  ) {
    this.method = method.toUpperCase(); // Ensure HTTP method is uppercase
    this.headers = this.normalizeHeaders(headers);
    this.body = body;
    this.url = url;
    this.urlInstance = new URL(url);
  }

  // Utility to get query parameters
  getQueryParam(name: string): string | null {
    return this.urlInstance.searchParams.get(name);
  }

  // Utility to get all query parameters as an object
  getAllQueryParams(): Record<string, string> {
    return Object.fromEntries(this.urlInstance.searchParams.entries());
  }

  // Utility to get a header value (case-insensitive)
  getHeader(name: string): string | null {
    return this.headers[name.toLowerCase()] || null;
  }

  // Utility to normalize headers (case-insensitive storage)
  private normalizeHeaders(headers: Record<string, string>): Record<string, string> {
    const normalizedHeaders: Record<string, string> = {};
    for (const [key, value] of Object.entries(headers)) {
      normalizedHeaders[key.toLowerCase()] = value;
    }
    return normalizedHeaders;
  }

  // Utility to safely parse JSON body
  parseJsonBody<T = any>(): T | null {
    if (typeof this.body === "string") {
      try {
        return JSON.parse(this.body);
      } catch (error) {
        console.warn("Failed to parse JSON body:", error);
        return null;
      }
    }
    return this.body as T;
  }

  // Get path name from URL
  get path(): string {
    return this.urlInstance.pathname;
  }
}

<% // Response Class %>
export class Response {
  statusCode: number;
  headers: Record<string, string>;
  body: any;

  constructor(
    statusCode: number = 200,
    headers: Record<string, string> = {},
    body: any = null
  ) {
    this.statusCode = statusCode;
    this.headers = this.normalizeHeaders(headers);
    this.body = body;
  }

  // Set status code
  setStatus(code: number): this {
    this.statusCode = code;
    return this;
  }

  // Add or update a header
  setHeader(name: string, value: string): this {
    this.headers[name.toLowerCase()] = value;
    return this;
  }

  // Convenience method to set multiple headers
  setHeaders(headers: Record<string, string>): this {
    for (const [key, value] of Object.entries(headers)) {
      this.setHeader(key, value);
    }
    return this;
  }

  // Send a JSON response
  sendJson(body: any): this {
    this.setHeader("Content-Type", "application/json");
    this.body = JSON.stringify(body);
    return this;
  }

  // Normalize headers (case-insensitive)
  private normalizeHeaders(headers: Record<string, string>): Record<string, string> {
    const normalizedHeaders: Record<string, string> = {};
    for (const [key, value] of Object.entries(headers)) {
      normalizedHeaders[key.toLowerCase()] = value;
    }
    return normalizedHeaders;
  }
}

<% // BaseHandler Class %>
interface Handler {
  get?(req: Request): Promise<Response>;
  post?(req: Request): Promise<Response>;
  put?(req: Request): Promise<Response>;
  delete?(req: Request): Promise<Response>;
}

export class BaseHandler implements Handler {
  // Handle GET request
  public async get(req: Request): Promise<Response> {
    return this.methodNotImplemented("GET");
  }

  // Handle POST request
  public async post(req: Request): Promise<Response> {
    return this.methodNotImplemented("POST");
  }

  // Handle PUT request
  public async put(req: Request): Promise<Response> {
    return this.methodNotImplemented("PUT");
  }

  // Handle DELETE request
  public async delete(req: Request): Promise<Response> {
    return this.methodNotImplemented("DELETE");
  }

  // Handle PATCH request
  public async patch(req: Request): Promise<Response> {
    return this.methodNotImplemented("PATCH");
  }

  // Handle HEAD request
  public async head(req: Request): Promise<Response> {
    return this.methodNotImplemented("HEAD");
  }

  // Handle OPTIONS request
  public async options(req: Request): Promise<Response> {
    return this.methodNotImplemented("OPTIONS");
  }

  // Utility to return a 501 Not Implemented response
  protected methodNotImplemented(method: string): Response {
    return new Response(501, { "Content-Type": "application/json" }, { error: `${method} method not implemented` });
  }

  // Utility to return a 400 Bad Request response
  protected badRequest(message: string = "Bad Request"): Response {
    return new Response(400, { "Content-Type": "application/json" }, { error: message });
  }

  // Utility to return a 404 Not Found response
  protected notFound(message: string = "Not Found"): Response {
    return new Response(404, { "Content-Type": "application/json" }, { error: message });
  }

  // Utility to return a 500 Internal Server Error response
  protected internalServerError(message: string = "Internal Server Error"): Response {
    return new Response(500, { "Content-Type": "application/json" }, { error: message });
  }
}